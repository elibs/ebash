#!/usr/bin/env bash
#
# Copyright 2021, Marshall McMullen <marshall.mcmullen@gmail.com>
#
# This program is free software: you can redistribute it and/or modify it under the terms of the Apache License
# as published by the Apache Software Foundation, either version 2 of the License, or (at your option) any later
# version.

: ${EBASH_HOME:=$(dirname $0)/..}
: ${EBASH:=${EBASH_HOME}/share}
__EBASH_SAVE_DOC=1
source "${EBASH}/ebash.sh" || { echo "Unable to source ${EBASH}/ebash.sh" ; exit 1 ; }

# Pretend that this is ubuntu 16.04, whether it is or not
os() { [[ ${1,,} == linux ]] && return 0 || return 1 ; }
lsb_release() { echo "16.04" ; }
{
    echo 'export __EBASH_OS="Linux"'
    declare -f opt_usage
    declare -f os
    declare -f lsb_release
} > edoc.sh
trap_add "rm edoc.sh"

dir="doc/module"
efreshdir "${dir}"
mkdir -p "${dir}"
echo "# Modules" > "${dir}/index.md"

for module in ${EBASH}/*.sh; do

    name=$(basename ${module} .sh)

    if [[ "${name}" == @(ebash) ]]; then
        continue
    fi

    ebanner "${name}"
    echo "[${name}](${name}.md)<br>" >> "${dir}/index.md"
    printf "# Module ${name}\n\n" > "${dir}/${name}.md"

    # Try to get any module level documentation (if any)
    if [[ -v __EBASH_DOC[module_$name] ]]; then
        echo "${__EBASH_DOC["module_$name"]}" >> "${dir}/${name}.md"
    fi

    # If this is the opt.sh module extract the module level documentation. This can't use normal opt_parse idiom as it
    # IS the opt parsing code.
    if [[ "${name}" == "opt" ]]; then
        awk '/^END/ {exit} /: <</ {f=1; next} f' share/opt.sh >> "${dir}/opt.md"
    fi

    ## ALIASES ##
    for alias in $(env -i bash -c "source edoc.sh; source ${module}; alias | awk -F'=' '/^alias / {print \$1}' | sed 's|alias ||'"); do

        if [[ -v __EBASH_DOC[$alias] ]]; then
            einfo "Alias:    ${alias}"
            {
                printf "\n## alias ${alias}\n\n"
                echo "${__EBASH_DOC[$alias]}"
            } >> "${dir}/${name}.md"
        fi
    done

    ## FUNCTIONS ##
    for function in $(env -i bash -c "source edoc.sh; source ${module}; declare -F" | sed -e 's|declare -f\S* ||' | tr ' ' '\n'); do

        if [[ "${function}" == "os" || "${function:0:1}" == "_" ]]; then
            continue
        fi

        # See if there is opt_usage for this function
        if [[ -v __EBASH_DOC[$function] ]]; then
            einfo "Function: ${function}"
            {
                printf "\n## func ${function}\n\n"

                if declare -pf "${function}" | grep --quiet '$(opt_parse '; then
                    ${function} --help 2>&1 | sed -e '/SYNOPSIS/,/DESCRIPTION/d' -e '0,/^$/{//d}' \
                                                  -e ':a;N;$!ba;s/\(ARGUMENTS\|OPTIONS\)\(.*\)/```Groff\n\1\2\n```/'
                else
                    echo "${__EBASH_DOC[$function]}"
                fi
            } >> "${dir}/${name}.md"
        fi
    done
done
